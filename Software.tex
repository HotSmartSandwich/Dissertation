\chapter{Информационно-управляющая система}
В ходе выполнения работы, были рассмотрены различные варианты управления промышленным роботом-манипулятором.
В связи с проприетарностью встроенного программного обеспечения, при разработке информационно-управляющей системы оставалось только использовать весьма ограниченный функционал, предлагаемый производителем.
Задача сводилась к разработке наиболее удобного способа формирования траектории движения рабочего инструмента.


\section{Генерирование программ работы робота}
Базовым и наиболее распространённым в промышленности способом является программирование напрямую через пульт управления (Teach Pendant).
Оператор вручную задаёт координаты каждой точки и ориентацию рабочего инструмента робота, либо сохраняет их в режиме обучения.
Главным преимуществом такого способа является простота и относительная быстрота написания простых программ работы.
Однако, он категорически не подходит для задания более сложных траекторий, какой и является траектория наплавки.

Для написания программ, описывающих сложные траектории движения существуют различные CAD/CAM системы, единственным значимым недостатком которых является высокая стоимость и строго ограниченный инструментарий.

Изучив возможность самостоятельного написания и загрузки программ работы робота в контроллер, было принято решение спроектировать и разработать собственное приложение, включающее в себя пользовательский графический интерфейс для создания и редактирования траекторий наплавки и постпроцессор -- программное обеспечение, позволяющее преобразовать заданную оператором траекторию в программу работы для контроллера робота.
Похожий подход был применён в статье~\cite{Nagata_2017}, но в ней рассматривается исключительно интерполяция уже готового набора данных дугами.

Основные расширения файлов программ, с которыми работают контроллеры FANUC -- это «.ls» и «.tp».

Файл с расширением «.ls» -- это листинг программы, текстовый файл с ASCII кодировкой, для открытия и редактирования которого может быть использован любой текстовый редактор.
Представляет из себя два основных блока: блок движений (/MN), описывающий все действия робота, и блок позиций (/POS), в котором находится информация обо всех положениях, используемых в программе.
Пример оформления и синтаксиса приведён в листинге~\ref{lst:LS example}.

\begin{lstlisting}[caption={Пример оформления .LS файлов}, label={lst:LS example}]
	/PROG EXAMPLE.LS

	/ATTR

	/MN
	:J P[1] 10% FINE;
	:  WAIT 1.5(sec);
	:L P[2] 250mm/sec CNT50;
	:L P[3] 4sec CNT100;
	:J P[1] 5% FINE;

	/POS
	P[1]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 729.8 mm,	Y = 134.9 mm,	Z = 181.1 mm,
		W = 191.2 deg,	P = 13.3 deg,	R = 14.2 deg
	};

	P[2]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 693.6 mm,	Y = 695.6 mm,	Z = 0.0 mm,
		W = 120.0 deg,	P = -9.9 deg,	R = -46.8 deg
	};

	P[3]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 512.9 mm,	Y = 129.8 mm,	Z = -31.5 mm,
		W = 191.5 deg,	P = 43.1 deg,	R = 45.1 deg
	};

	/END
\end{lstlisting}

Файл с расширение «.tp» -- это скомпилированная программа в виде байт-кода.
Старые контроллеры FANUC не имеют пакета «ASCII Upload», позволяющего компилировать файлы с расширением «.ls» при их загрузке в контроллер.
Поэтому они должны быть скомпилированы предварительно.
Компиляция выполняется при помощи пакета программ FANUC WinOLPC .

Для роботов FANUC целевая точка может задаваться двумя способами.

Первый способ -- через задание углов поворота каждого сочленения робота ($J_1$, $J_2$, $J_3$, $J_4$, $J_5$, $J_6$).
Пример задания целевой точки этим способом приведён в листинге~\ref{lst:Joints target point}.

\begin{lstlisting}[caption={Целевая точка через углы J1 -- J6}, label={lst:Joints target point}]
	P[1]{
		UF : 1, UT : 1,
		J1 =   49.399 deg,    J2 =   10.072 deg,    J3 =  -24.105 deg,
		J4 =    -.000 deg,    J5 =  -65.895 deg,    J6 =   40.601 deg
	};
\end{lstlisting}

Второй способ -- через шесть координат, три из которых определяют положение целевой точки (X, Y, Z), а другие три -- ориентацию рабочего инструмента в абсолютной системе координат, связанной с основанием робота (W, P, R).
Пример задания целевой точки приведён в листинге~\ref{lst:XyzWpr target point}.

\begin{lstlisting}[caption={Целевая точка через координаты XYZWPR}, label={lst:XyzWpr target point}]
	P[1]{
		UF : 1, UT : 1,        CONFIG : 'N U T, 0, 0, 0',
		X =   750.000  mm,    Y =   800.000  mm,    Z =   225.000  mm,
		W =   180.000 deg,    P =     0.000 deg,    R =    90.000 deg
	};
\end{lstlisting}

Этот способ задания является наиболее удобным и информативным для оператора, так как ссылается на понятные человеку пространственные координаты.
Однако, он не является однозначным: в одной и той же точке, с одной и той же ориентацией рабочего инструмента, робот может находиться несколькими способами, пример чего приведён на рисунке~\ref{fig:Robot Configuration}.

\begin{figure}[H]
    \centering
    \vspace{14pt}
    \includegraphics[height=10cm]{Figures/Software/RobotConfiguration}
    \caption{Разная конфигурация робота в одной и той же целевой точке}
    \label{fig:Robot Configuration}
\end{figure}

Конкретная конфигурация робота задаётся для каждой точки отдельно при помощи параметра «CONFIG» (листинг~\ref{lst:XyzWpr target point}).

Параметр «CONFIG» для роботов FANUC с кинематической схемой PUMA состоит из трёх буквенных и трёх численных обозначений.
Буквенные обозначения позволяют однозначно определить положение звеньев робота.
Расшифровка буквенных обозначений приведена в таблице~\ref{tab:Robot Config}.

\begin{longtable}[H]{|p{0.25\linewidth}|p{0.25\linewidth}|p{0.4\linewidth}|}
    \caption{Расшифровка буквенных обозначений}
    \label{tab:Robot Config} \\
    \hline
    Обозначение & Расшифровка   & Значение                \\ \hline
    N           & wrist No-flip & запястье не перевёрнуто \\ \hline
    F           & wrist Flip    & запястье перевёрнуто    \\ \hline
    U           & elbow Up      & локоть вверх            \\ \hline
    D           & elbow Down    & локоть вниз             \\ \hline
    T           & config Top    & подход спереди          \\ \hline
    B           & config Bottom & подход сзади            \\ \hline
\end{longtable}

Большая часть приведённых конфигураций является экзотической.
Как правило, в работе используется конфигурация «NUT» и в ходе выполнения программы она не изменяется.

Численные обозначения указывают количество полных оборотов сверх необходимого угла поворота для многооборотных сочленений.
Как правило, количество полных оборотов необходимо учитывать при задании таких траекторий, когда происходит перекручивание запястья робота.
При работе со сварочной горелкой, кабель которой закреплён не в полом запястье робота, а снаружи, такие перекручивания недопустимы, потому конфигурация «N U T, 0, 0, 0» принимается постоянной.


\section{Генерирование траектории движения}
В технологических процессах, связанных с операциями сварки и наплавки, как правило, определяются лишь основные сварочные параметры: вид сварки, присадочный материал, режимы работы сварочного аппарата.
В случае наплавки также указывается частота и амплитуда колебаний.
Но почти никогда не даётся рекомендаций касательно выбора типа сварочных колебаний.
Выбор конкретного паттерна колебаний чаще всего остаётся непосредственно за сварщиком, что приводит к увеличению разброса качества конечной продукции.

Для того чтобы проследить влияние выбора типа колебаний и их конкретных параметров на конечный результат, в рамках этой работы был разработан модуль, позволяющий универсальным способом задавать траекторию движения сварочной горелки с независимым наложением на неё колебаний разных типов.

%В готовых решениях для сварки и наплавки регулируется лишь относительно небольшое число параметров траектории рабочего инструмента: скорость движения, частота и амплитуда колебаний.
%Решения для роботизированной сварки/наплавки, как, например, FANUC ArcTool и KUKA.ArcTech предлагают готовый инструментарий для создания траекторий лишь с некоторыми типами колебаний.

Траектория движения сварочной горели строится на основании двух составляющих: путь и накладываемые на него колебания.
В рамках работы было реализовано два типа путей:

\begin{itemize}
    \item по окружности, с указанием диаметра окружности, начального и конечного углов;
    \item по прямой, с указанием начальной и конечной точек.
\end{itemize}

Также были разработаны различные типы колебаний:

\begin{itemize}
    \item круговые;
    \item зигзагообразные;
    \item синусоидальные;
    \item колебания восьмёркой.
\end{itemize}

Для создания траектории движения, сначала выбирается тип пути.
После чего, задаётся тип колебаний и их основные параметры, подбираемые на основе значений, указанных в технологическом процессе.
Как правило, это скорость, частота, амплитуда.

Наконец, редактируется точный вид колебаний при помощи редактора траектории.

Отличительной особенностью разработанного редактора явлется простота и универсальность разработки типов колебаний и их независимое от внешнего вида траектория движения редактирование.

% --------old--------
Наплавка осуществляется слоями, каждый слой состоит из нескольких концентрических окружностей, называемых валиками.
Отдельные валики наплавляются последовательно, с перерывами для того, чтобы не перегреть изделие.
После наплавки каждого валика проводится зачистка поверхности наплавленного металла от шлака и брызг металла, а также осуществляется визуальный осмотр качества наплавки.

Траектория наплавки формируется согласно параметрам, прописанным в технологическом процессе для конкретного изделия.
Определяются такие параметры, как скорость движения сварочной горелки, амплитуда и частота колебаний, величина перекрытия валиков.
Так как технологический процесс разработан для наплавки вручную, то все эти параметры указываются в виде допустимого диапазона с учётом возможных неточностей в работе сварщика.
В случае роботизированной наплавки конкретные значения параметров выбираются из диапазона оператором исходя из внешнего вида предполагаемой траектории.
%Предварительный внешний вид траектории рабочего инструмента при проведении технологических операций наплавки приведён на рисунке~\ref{fig:ch2:Welding Trajectory}.

%\begin{figure}[H]
%    \centering
%    \vspace{14pt}
%    \includegraphics[height=10cm]{Figures/_old/ch2/Welding Trajectory}
%    \caption{Траектория наплавки}
%    \label{fig:ch2:Welding Trajectory}
%\end{figure}

Траектория задаётся отдельно для каждого валика в параметрическом виде:

\begin{gather*}
    \begin{bmatrix}
        x \\
        y
    \end{bmatrix} = radius \cdot
    \begin{bmatrix}
        \cos(t) \\
        \sin(t)
    \end{bmatrix}
    +
    \begin{bmatrix}
        \cos(t) & -\sin(t) \\
        \sin(t) & \cos(t)
    \end{bmatrix}
    \times
    \begin{bmatrix}
        AmplitudeHeight \cdot \sin(n \cdot t) \\
        AmplitudeWidth \cdot \cos(n \cdot t)
    \end{bmatrix}, \\
    n = \pi \cdot diameter \cdot \dfrac{WeldingFrequency}{WeldingSpeed},
\end{gather*} \\
где $radius$  и $diameter$ -- радиус и диаметр окружности, \\
$AmplitudeHeight$ и $AmplitudeWidth$ -- амплитуды колебаний, \\
$n$ -- количество колебаний, \\
$WeldingFrequency$ -- частота колебаний, \\
$WeldingSpeed$ -- скорость движения рабочего инструмента.

Непосредственно на контроллер робота программа работы передаётся в виде набора точек -- от пятисот до полутора тысяч в зависимости от параметров конкретной траектории.


\section{Программное обеспечение}
На рисунке~\ref{fig:System Schema} изображена функциональная схема разработанной информационно-управляющей системы.

\begin{figure}[H]
    \centering
    \vspace{14pt}
    \includegraphics[width=\linewidth]{Figures/Software/SystemSchema}
    \caption{Функциональная схема разработанной информационно-управляющей системы}
    \label{fig:System Schema}
\end{figure}

Как видно из рисунка~\ref{fig:System Schema}, система разделена на подсистемы, каждая из которых отвечает за выполнение конкретной задачи.

\subsection{Подсистема коммуникации}
Подсистема коммуникации отвечает за установку соединения с контроллером робота.
Она предоставляет интерфейсы для других подсистем, позволяющие получать данные о состоянии робота и его текущем положении, считывать и записывать значения внутренних переменных контроллера робота.

Также подсистема коммуникации отвечает за загрузку скомпилированных программ работы робота по протоколу FTP. Во время передачи контроллер робота выступает в роли сервера, а подсистема коммуникации в роли клиента.

\subsection{Подсистема управления}
Для функционирования разработанной системы, на контроллере робота резервируются внутренние переменные.
При помощи считывания и записи значений этих переменных, осуществляется коммуникация между контроллером робота и системой.
Отдельные переменные отводятся под разрешение на выполнение работы, разрешение на зажигание сварочной дуги, записи текущего состояния робота и так далее.

За считывание и запись этих переменных отвечает подсистема управления, использующая соответствующий интерфейс обмена данными, предоставляемый подсистемой коммуникации.

Также подсистема управления инициирует начало процесса генерации управляющих программ и их загрузку на контроллер робота.

\subsection{Подсистема мониторинга}
Подсистема мониторинга в режиме реального времени отслеживает изменения положения робота и его состояний при помощи соответствующего интерфейса, предоставляемого подсистемой коммуникации.

Все изменения передаются в подсистему отображения для информирования оператора.

\subsection{Подсистема отображения}
Подсистема отображения отвечает за предоставление оператору полнофункционального пользовательского интерфейса.
В интерфейсе отображаются состояние робота и его текущее положение, параметры работы.

При помощи пользовательского интерфейса оператор имеет возможность редактировать конфигурации программ работы робота и траектории движения сварочной горелки.
Любые внесённые оператором изменения передаются в подсистему конфигурации, где значения параметров проходят проверку на корректность и сохраняются.
При изменении параметров траектории движения, её вид обновляется в пользовательском интерфейсе в режиме реального времени.

\subsection{Подсистема конфигурации}
Подсистема конфигурации отвечает за сохранение новых конфигураций и управление существующими конфигурациями программ работы робота.

Конфигурация представляет собой набор значений всех параметров, полностью описывающий рабочую программу робота.

Все конфигурации хранятся в базе конфигураций и загружаются по запросу от оператора, для чего подсистема конфигурации предоставляет интерфейс для подсистемы отображения.

\subsection{Постпроцессор}

