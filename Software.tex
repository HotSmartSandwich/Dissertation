\chapter{Информационно-управляющая система}
В ходе выполнения работы, были рассмотрены различные варианты управления промышленным роботом-манипулятором.
В связи с проприетарностью встроенного программного обеспечения, при разработке информационно-управляющей системы оставалось только использовать ограниченный функционал, предлагаемый производителем оборудования.
Задача сводилась к разработке наиболее удобного способа формирования траектории движения рабочего инструмента.


\section{Программа работы робота}

\subsection{Основные способы создания программ}
Базовым и наиболее распространённым в промышленности способом является программирование напрямую через пульт управления (Teach Pendant).
Оператор вручную задаёт координаты каждой точки и ориентацию рабочего инструмента робота, либо сохраняет их в режиме обучения.
Главным преимуществом такого способа является простота и относительная быстрота написания простых программ работы.
Однако, он категорически не подходит для задания более сложных траекторий, какой и является траектория наплавки.

Для написания программ, описывающих сложные траектории движения существуют различные CAD/CAM системы, единственным значимым недостатком которых является высокая стоимость и строго ограниченный инструментарий.
Сами же сгенерированные траектории движения представляют из себя массивы из множества точек.

Изучив возможность самостоятельного написания и загрузки программ работы робота в контроллер, было принято решение спроектировать и разработать собственное приложение, включающее в себя пользовательский графический интерфейс для создания и редактирования траекторий наплавки и постпроцессор -- программное обеспечение, позволяющее преобразовать заданную оператором траекторию в программу работы для контроллера робота.
Похожий подход был применён в работе~\cite{Nagata_2017}, но в ней рассматривается исключительно интерполяция уже готового набора данных дугами.

\subsection{Структура программ работы} \label{subsec:ProgramStructure}
Основные расширения файлов программ, с которыми работают контроллеры FANUC -- это <<.LS>> и <<.TP>>.

Файл с расширением <<.LS>> -- это листинг программы, текстовый файл с ASCII кодировкой, для открытия и редактирования которого может быть использован любой текстовый редактор.
Представляет из себя два основных блока: блок движений <</MN>>, описывающий все действия робота в виде инструкций, и блок позиций <</POS>>, в котором находится информация о координатах всех точек, используемых в программе.
Пример оформления и синтаксиса приведён в листинге~\ref{lst:LS-Example}.

\begin{lstlisting}[caption={Пример оформления .LS файлов}, label={lst:LS-Example}]
	/PROG EXAMPLE.LS

	/ATTR

	/MN
	:J P[1] 10% FINE;
	:  WAIT 1.5(sec);
	:L P[2] 250mm/sec CNT50;
	:L P[3] 4sec CNT100;
	:J P[1] 5% FINE;

	/POS
	P[1]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 729.8 mm,	Y = 134.9 mm,	Z = 181.1 mm,
		W = 191.2 deg,	P = 13.3 deg,	R = 14.2 deg
	};

	P[2]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 693.6 mm,	Y = 695.6 mm,	Z = 0.0 mm,
		W = 120.0 deg,	P = -9.9 deg,	R = -46.8 deg
	};

	P[3]{
		GP1:
		UF: 1, UT: 1,	CONFIG: 'N U T, 0, 0, 0',
		X = 512.9 mm,	Y = 129.8 mm,	Z = -31.5 mm,
		W = 191.5 deg,	P = 43.1 deg,	R = 45.1 deg
	};

	/END
\end{lstlisting}

Файл с расширением <<.TP>> -- это скомпилированная программа в виде байт-кода.
Старые контроллеры FANUC не имеют пакета <<ASCII Upload>>, позволяющего компилировать файлы с расширением <<.LS>> при их загрузке в контроллер.
Поэтому они должны быть скомпилированы предварительно.
Компиляция выполняется при помощи пакета программ FANUC WinOLPC .

\subsection{Конфигурация робота}
Для роботов FANUC целевая точка может задаваться двумя способами.

Первый способ -- через задание углов поворота каждого сочленения робота ($J_1$, $J_2$, $J_3$, $J_4$, $J_5$, $J_6$).
Пример задания целевой точки этим способом приведён в листинге~\ref{lst:J16-TargetPoint}.

\begin{lstlisting}[caption={Задание целевой точки с помощью углов J1-J6}, label={lst:J16-TargetPoint}]
	P[1]{
		UF : 1, UT : 1,
		J1 =   49.399 deg,    J2 =   10.072 deg,    J3 =  -24.105 deg,
		J4 =    -.000 deg,    J5 =  -65.895 deg,    J6 =   40.601 deg
	};
\end{lstlisting}

Второй способ -- через шесть координат, три из которых определяют положение целевой точки (X, Y, Z), а другие три -- ориентацию рабочего инструмента в абсолютной системе координат, связанной с основанием робота (W, P, R).
Пример задания целевой точки приведён в листинге~\ref{lst:XYZWPR-TargetPoint}.

\begin{lstlisting}[caption={Задание целевой точки с помощью координат XYZWPR}, label={lst:XYZWPR-TargetPoint}]
	P[1]{
		UF : 1, UT : 1,        CONFIG : 'N U T, 0, 0, 0',
		X =   750.000  mm,    Y =   800.000  mm,    Z =   225.000  mm,
		W =   180.000 deg,    P =     0.000 deg,    R =    90.000 deg
	};
\end{lstlisting}

Этот способ задания является наиболее удобным и информативным для оператора, так как ссылается на понятные человеку пространственные координаты.
Однако, он не является однозначным: в одной и той же точке, с одной и той же ориентацией рабочего инструмента, робот может находиться несколькими способами, пример чего приведён на рисунке~\ref{fig:RobotConfiguration}.

\begin{figure}[H]
    \centering
    \vspace{14pt}
    \includegraphics[height=10cm]{Figures/Software/RobotConfiguration}
    \caption{Разная конфигурация робота в одной и той же целевой точке}
    \label{fig:RobotConfiguration}
\end{figure}

Конкретная конфигурация робота задаётся для каждой точки отдельно при помощи параметра <<CONFIG>> (листинг~\ref{lst:XYZWPR-TargetPoint}).

Параметр <<CONFIG>> для роботов FANUC с кинематической схемой <<Puma>> состоит из трёх буквенных и трёх численных обозначений.
Буквенные обозначения позволяют однозначно определить положение звеньев робота.
Расшифровка буквенных обозначений приведена в таблице~\ref{tab:RobotConfig}.

\begin{longtable}[H]{|p{0.25\linewidth}|p{0.25\linewidth}|p{0.4\linewidth}|}
    \caption{Расшифровка буквенных обозначений}
    \label{tab:RobotConfig} \\
    \hline
    Обозначение & Расшифровка   & Значение                \\ \hline
    N           & wrist No-flip & запястье не перевёрнуто \\ \hline
    F           & wrist Flip    & запястье перевёрнуто    \\ \hline
    U           & elbow Up      & локоть вверх            \\ \hline
    D           & elbow Down    & локоть вниз             \\ \hline
    T           & config Top    & подход спереди          \\ \hline
    B           & config Bottom & подход сзади            \\ \hline
\end{longtable}

Большая часть приведённых конфигураций является экзотической.
Как правило, в работе используется конфигурация <<NUT>> и в ходе выполнения программы она не изменяется.

Численные обозначения указывают на количество полных оборотов сверх необходимого угла поворота для многооборотных сочленений.
Как правило, количество полных оборотов необходимо учитывать при задании таких траекторий, когда происходит перекручивание запястья робота.

При работе со сварочной горелкой, кабель которой закреплён не в полом запястье робота, а снаружи, такие перекручивания недопустимы, потому в дальнейшей работе конфигурация <<N U T, 0, 0, 0>> принимается постоянной и неизменяемой.


\section{Траектория движения}

\subsection{Параметры траектории движения} \label{subsec:TrajectoryParameters}
В технологических процессах, связанных с операциями сварки и наплавки, как правило, определяются лишь основные сварочные параметры: вид сварки, присадочный материал, режимы работы сварочного аппарата.
В случае наплавки также указывается частота и амплитуда колебаний.
Но почти никогда не даётся рекомендаций касательно выбора типа сварочных колебаний.
Выбор конкретного паттерна колебаний чаще всего остаётся непосредственно за сварщиком, что приводит к ещё большему увеличению в разбросе качества конечной продукции.

Рассматриваемые в главе~\ref{ch:SolutionsOverview} установки для наплавки, как правило, реализуют только зигзагообразные колебания.
Решения для роботизированной сварки/наплавки, как, например, FANUC ArcTool и KUKA.ArcTech предлагают готовый инструментарий для задания сварочной траектории с колебаниями лишь из узкого набора предустановленных паттернов с ограниченной возможностью их параметрического редактирования.

Для того чтобы проследить влияние выбранного типа колебаний и их конкретных параметров на качество конечной продукции, в рамках этой работы был разработан программный модуль, позволяющий универсальным способом задавать траекторию движения сварочной горелки с независимым наложением на неё колебаний разных типов.

Траектория движения сварочной горели строится на основании двух составляющих: путь и накладываемые на него колебания.

Было реализовано два типа путей:

\begin{itemize}
    \item по окружности, с указанием диаметра окружности, начального и конечного углов;
    \item по прямой, с указанием начальной и конечной точек.
\end{itemize}

Также были разработаны различные типы колебаний:

\begin{itemize}
    \item круговые;
    \item зигзагообразные;
    \item синусоидальные;
    \item колебания восьмёркой.
\end{itemize}

\subsection{Создание траектории движения}
При создания траектории движения, сначала выбирается тип пути.
После, задаётся тип колебаний и их основные параметры, прописанные в технологическом процессе для конкретного изделия.

Так как технологический процесс разработан для наплавки вручную, то все эти параметры указываются в виде допустимого диапазона с учётом возможных неточностей в работе сварщика.
В случае роботизированной наплавки, конкретные значения параметров выбираются из диапазона оператором исходя из внешнего вида предполагаемой траектории.

Как было описано в разделе~\ref{subsec:ProgramStructure}, на контроллер робота программа работы передаётся в виде набора инструкций и используемых в программе положений.
Таким образом, траектория движения робота представляет собой набор точек.

Количество точек напрямую зависит от параметров конкретной траектории и должно подбираться оператором исходя из её внешнего вида.
Для более простых траекторий с небольшим итоговым числом колебаний, количество точек может быть значительно меньше, чем для более сложных траекторий.
Недостаточное количество точек может привести к значительному снижению точности движения по траектории.
Чрезмерно завышенное число точек, в свою очередь, существенно сказывается на времени компиляции и загрузки программы работы.
К тому же, более старые версии контроллеров не всегда справляются с обработкой программ работы большого объёма.
Пример внешнего вида одной и той же траектории при разном количестве точек приведён на рисунке~\ref{fig:LowPointTrajectoryExample}.

\begin{figure}[H]
    \centering
    \vspace{14pt}
    \includegraphics[width=\linewidth]{Figures/Software/LowPointTrajectoryExample}
    \caption{Траектория при разном количестве точек}
    \label{fig:LowPointTrajectoryExample}
\end{figure}

Для того, чтобы иметь возможность менять количество точек в траектории, сама траектория должна описываться в параметрическом виде, где координаты каждой точки зависят от некоторого параметра $t$.
Величина шага изменения этого параметра и будет влиять на количество точек.

Как было указано в разделе~\ref{subsec:TrajectoryParameters}, траектория движения состоит из основного пути движения и наложенных на него колебаний.

И основной путь, и колебания представляют собой набор точек.
Наложение колебаний осуществляется за счёт сложения координат точек основного пути движения с координатами соответствующих точек колебаний.

Для примера, рассмотрим траекторию, приведённую на рисунке~\ref{fig:LowPointTrajectoryExample}.
Это траектория движения по окружности с круговые колебания.

Сперва, вычисляется массив точек, из которых состоит основная траектория:

\begin{gather*}
    \begin{bmatrix}
        x_p \\
        y_p
    \end{bmatrix}
    = \dfrac{D}{2} \cdot
    \begin{bmatrix}
        \cos{t} \\
        \sin{t}
    \end{bmatrix}, \\
    0 \leq t \leq 2 \pi,
\end{gather*} \\
где $D$ -- диаметр окружности.

Для корректной генерации колебаний, для начала необходимо вычислить их количество для выбранного пути и соответствующих параметров скорости перемещения и частоты:

\begin{equation*}
	F_N = \dfrac{2 \pi \cdot D}{S} \cdot F,
\end{equation*} \\
где $F_N$ -- количество колебаний, $S$ -- скорость движения по траектории, $F$ -- частота колебаний.



\begin{gather*}
    \begin{bmatrix}
        x_o \\
        y_o
    \end{bmatrix}
    = \dfrac{D}{2} \cdot
    \begin{bmatrix}
        \cos{t} \\
        \sin{t}
    \end{bmatrix}, \\
    0 \leq t \leq 2 \pi,
\end{gather*} \\



\begin{gather*}
    \begin{bmatrix}
        x \\
        y
    \end{bmatrix} = radius \cdot
    \begin{bmatrix}
        \cos(t) \\
        \sin(t)
    \end{bmatrix}
    +
    \begin{bmatrix}
        \cos(t) & -\sin(t) \\
        \sin(t) & \cos(t)
    \end{bmatrix}
    \times
    \begin{bmatrix}
        AmplitudeHeight \cdot \sin(n \cdot t) \\
        AmplitudeWidth \cdot \cos(n \cdot t)
    \end{bmatrix}, \\
    n = \pi \cdot diameter \cdot \dfrac{WeldingFrequency}{WeldingSpeed},
\end{gather*} \\
где $radius$  и $diameter$ -- радиус и диаметр окружности, \\
$AmplitudeHeight$ и $AmplitudeWidth$ -- амплитуды колебаний, \\
$n$ -- количество колебаний, \\
$WeldingFrequency$ -- частота колебаний, \\
$WeldingSpeed$ -- скорость движения рабочего инструмента.


%Отличительной особенностью разработанного редактора явлется простота и универсальность разработки типов колебаний и их независимое от внешнего вида траектория движения редактирование.


\section{Программное обеспечение}
На рисунке~\ref{fig:SystemSchema} изображена функциональная схема разработанной информационно-управляющей системы.

\begin{figure}[H]
    \centering
    \vspace{14pt}
    \includegraphics[width=\linewidth]{Figures/Software/SystemSchema}
    \caption{Функциональная схема разработанной информационно-управляющей системы}
    \label{fig:SystemSchema}
\end{figure}

Как видно из рисунка~\ref{fig:SystemSchema}, система разделена на подсистемы, каждая из которых отвечает за выполнение конкретной задачи.

\subsection{Подсистема коммуникации}
Подсистема коммуникации отвечает за установку соединения с контроллером робота.
Она предоставляет интерфейсы для других подсистем, позволяющие получать данные о состоянии робота и его текущем положении, считывать и записывать значения внутренних переменных контроллера робота.

Также подсистема коммуникации отвечает за загрузку скомпилированных программ работы робота по протоколу FTP. Во время передачи контроллер робота выступает в роли сервера, а подсистема коммуникации в роли клиента.

\subsection{Подсистема управления}
Для функционирования разработанной системы, на контроллере робота резервируются внутренние переменные.
При помощи считывания и записи значений этих переменных, осуществляется коммуникация между контроллером робота и системой.
Отдельные переменные отводятся под разрешение на выполнение работы, разрешение на зажигание сварочной дуги, записи текущего состояния робота и так далее.

За считывание и запись этих переменных отвечает подсистема управления, использующая соответствующий интерфейс обмена данными, предоставляемый подсистемой коммуникации.

Также подсистема управления инициирует начало процесса генерации управляющих программ и их загрузку на контроллер робота.

\subsection{Подсистема мониторинга}
Подсистема мониторинга в режиме реального времени отслеживает изменения положения робота и его состояний при помощи соответствующего интерфейса, предоставляемого подсистемой коммуникации.

Все изменения передаются в подсистему отображения для информирования оператора.

\subsection{Подсистема отображения}
Подсистема отображения отвечает за предоставление оператору полнофункционального пользовательского интерфейса.
В интерфейсе отображаются состояние робота и его текущее положение, параметры работы.

При помощи пользовательского интерфейса оператор имеет возможность редактировать конфигурации программ работы робота и траектории движения сварочной горелки.
Любые внесённые оператором изменения передаются в подсистему конфигурации, где значения параметров проходят проверку на корректность и сохраняются.
При изменении параметров траектории движения, её вид обновляется в пользовательском интерфейсе в режиме реального времени.

\subsection{Подсистема конфигурации}
Подсистема конфигурации отвечает за сохранение новых конфигураций и управление существующими конфигурациями программ работы робота.

Конфигурация представляет собой набор значений всех параметров, полностью описывающий рабочую программу робота.

Все конфигурации хранятся в базе конфигураций и загружаются по запросу от оператора, для чего подсистема конфигурации предоставляет интерфейс для подсистемы отображения.

\subsection{Постпроцессор}

